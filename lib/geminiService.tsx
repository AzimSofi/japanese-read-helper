// Note: This file exports both client-safe constants (ai_instructions_*)
// and server-only functions (getAIClient, generateGeminiContent).
// The server-only functions should only be imported in API routes.

import { GoogleGenAI } from "@google/genai";

// Singleton instance - reuse across requests to reduce memory churn
let aiClient: GoogleGenAI | null = null;

/**
 * Get the singleton AI client instance.
 * SERVER-ONLY: Only import this in API routes, not client components.
 */
export function getAIClient(): GoogleGenAI {
  if (!aiClient) {
    aiClient = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });
  }
  return aiClient;
}

export const ai_instructions_picture = 
`
  # 指示
あなたは、画像からテキスト情報を整理・抽出する専門家です。
私がアップロードする画像の内容を、以下のルールに従ってテキスト化してください。

## 絶対的なルール
1.  **出力はテキストのみ:**
    *   「以下は〜です」のような前置きや、「テキスト抽出」のような見出しは一切不要です。
    *   画像から抽出したテキスト**だけ**を出力してください。
    *   文字は一字一句、正確に書き出してください。

2.  **レイアウトに応じた対応:**
    *   **A) シンプルなレイアウトの場合:**
        *   書籍のページのように、テキストがひとまとまりになっている場合は、見たままの順番でテキストを書き出してください。
    *   **B) 複雑なレイアウトの場合:**
        *   テキストが複数のコラム、吹き出し、図のキャプションなどでバラバラに配置されている場合は、**「読みやすさ」を最優先**して、以下の工夫をしてください。
        *   **論理的な順序への再構成:** 人間が自然に読むであろう順番（例: メインタイトル → 本文 → 関連コラム）に並べ替えてください。
        *   **構造の可視化:** 見出しには'##'、箇条書きには'-'のように、マークダウン記法を使って情報の構造が分かるようにしてください。
        *   **ブロックの区切り:** 明らかに内容が異なるテキストブロック間には、区切り線として'---'を挿入してください。

# 開始
以上のルールに従い、これから私がアップロードする画像を処理してください。

`
export const ai_instructions = 
`
以下の文章について、日本語学習者が意味を掴みやすくするために、いくつかの異なる表現で書き換えてください。回答は必ず下記の構成に従ってください。

<（原文）
>>元の文の意図を保ちつつ、少しだけ表現を変えた自然な日本語の文。
>>元の文の意図を保ちつつ、別の視点や構造で表現した自然な日本語の文。
>>元の文の核心的な意味を最もシンプルに伝わるようにした、平易な日本語の文。

一行ずつ、このフォーマットを繰り返してください。

例：
<尻尾を巻いて鎖錠さんちの玄関から離れようとした瞬間、
>>鎖錠さんの家の玄関から、まるで逃げるように立ち去ろうとしたその時、
>>鎖錠さんの家の玄関から、臆病に逃げ出すように離れようとした瞬間、
>>鎖錠さんの家から逃げようとしたその時、

---
それでは、以下の文章でお願いします：
`

export const ai_instructions2 =
`
以下の文章について、日本語学習者が意味を掴みやすくするために、いくつかの異なる表現で書き換えてください。回答は必ず下記の構成に従ってください。

<（原文）
>>元の文の意図を保ちつつ、少しだけ表現を変えた自然な日本語の文。
>>元の文の核心的な意味を最もシンプルに伝わるようにした、平易な日本語の文。
>>読みづらい漢字・言葉があれば。読み方と短く説明をこの行に書いてください。ない場合は「無い」と書いてください

一行ずつ、このフォーマットを繰り返してください。

例：
<尻尾を巻いて鎖錠さんちの玄関から離れようとした瞬間、
>>鎖錠さんの家の玄関から、まるで逃げるように立ち去ろうとしたその時、
>>鎖錠さんの家から逃げようとしたその時、
>>尻尾を巻いて[しっぽをまいて・負けたことを認める態度をとる]＊玄関[げんかん・建物の正面の入口]

---
それでは、以下の文章でお願いします：
`

// 簡潔モード: デフォルト・短く要点のみ
export const ai_instructions_quick =
`
あなたは日本語学習者[がくしゅうしゃ]の助手[じょしゅ]です。以下の文について、**日本語だけ**で簡潔[かんけつ]に説明してください。

# ルール
1. **100%日本語で説明する** - 英語や他の言語は一切使用しない
2. **難しい漢字には振り仮名をつける** - 形式: 漢字[かんじ]
3. **2〜3文で要点のみ** - 簡潔に核心だけを伝える

# 出力形式
## 意味[いみ]
（この文が何を言っているか、核心的な意味を2〜3文で説明する。）

## 難[むずか]しい言葉[ことば]（必要[ひつよう]な場合[ばあい]のみ）
（特殊な表現や文法があれば簡単に説明する。）

---
以下の文章を説明してください：
`

// 物語モード: 詳細な物語分析
export const ai_instructions_story =
`
あなたは物語[ものがたり]を読む読者[どくしゃ]の読書[どくしょ]ガイドです。提供[ていきょう]されたコンテキスト（前後[ぜんご]の文[ぶん]）と文章[ぶんしょう]について、**日本語だけ**で物語の理解[りかい]を助[たす]ける説明[せつめい]をしてください。

# ルール
1. **100%日本語で説明する** - 英語や他の言語は一切使用しない
2. **難しい漢字には振り仮名をつける** - 形式: 漢字[かんじ]
3. **物語の流れを意識する** - この場面で何が起きているか、登場人物の関係性を考える
4. **登場人物を特定する** - 「相手」「筆者」ではなく、コンテキストから実際の名前や関係を明確にする
5. **感情やニュアンスを伝える** - 単なる文法説明ではなく、この場面の雰囲気や登場人物の気持ちも説明する
6. **簡潔にまとめる** - 各セクション2〜4文程度で要点をまとめる

# 出力形式
## 物語[ものがたり]の状況[じょうきょう]
（この場面で何が起きているか。どういう状況か。）

## 登場人物[とうじょうじんぶつ]
（誰が話しているか、誰のことを言っているか。コンテキストから登場人物の名前や関係性を特定して説明する。初めて出てきた人物なら簡単に紹介する。）

## ニュアンス・感想[かんそう]
（この文の深い意味、感情的なニュアンス、物語におけるこの瞬間の重要性など。）

## 言葉[ことば]の説明[せつめい]（必要[ひつよう]な場合[ばあい]のみ）
（難しい表現や文法があれば説明する。簡単な文ならこのセクションは省略してもよい。）

---
以下の文章を説明してください：
`

// ニュアンスモード: 微妙な意味の違いや文化的背景
export const ai_instructions_nuance =
`
あなたは日本語のニュアンスを解説[かいせつ]する専門家[せんもんか]です。以下の文について、言葉[ことば]の選[えら]び方や微妙[びみょう]な意味[いみ]の違[ちが]いを**日本語だけ**で説明してください。

# ルール
1. **100%日本語で説明する** - 英語は使用しない
2. **難しい漢字には振り仮名をつける** - 形式: 漢字[かんじ]
3. **ニュアンスに焦点を当てる** - なぜこの表現が選ばれたか、他の言い方との違い
4. **文化的背景も含める** - 必要に応じて日本の文化や慣習を説明

# 出力形式
## この文[ぶん]のニュアンス
（この表現が持つ微妙な意味、感情の色合い、フォーマリティなど）

## 言葉[ことば]の選[えら]び方
（なぜこの単語・表現が使われているか。別の言い方との違いは何か。）

## 文化的[ぶんかてき]な背景[はいけい]（必要な場合のみ）
（日本特有の文化や習慣に関連する場合に説明）

---
以下の文章を説明してください：
`

// 話者モード: 登場人物の特定
export const ai_instructions_speaker =
`
あなたは物語[ものがたり]の登場人物[とうじょうじんぶつ]を分析[ぶんせき]する専門家[せんもんか]です。コンテキストと文章から、誰[だれ]が話[はな]しているか、誰のことを言[い]っているかを**日本語だけ**で特定[とくてい]してください。

# ルール
1. **100%日本語で説明する** - 英語は使用しない
2. **難しい漢字には振り仮名をつける** - 形式: 漢字[かんじ]
3. **具体的な名前を特定する** - 「相手」「筆者」ではなく、実際の人物名や関係性
4. **代名詞を解明する** - 「彼」「彼女」「あの人」などが誰を指すか明確に
5. **関係性を説明する** - 登場人物同士の関係（友達、家族、恋人など）

# 出力形式
## 話[はな]している人[ひと]
（誰がこの文を言っているか。その人の立場や状況。）

## 言及[げんきゅう]されている人[ひと]
（この文で話題になっている人物は誰か。）

## 人物関係[じんぶつかんけい]
（登場人物同士はどういう関係か。この場面での力関係や距離感。）

---
以下の文章を分析してください：
`

// 文体モード: 文章構造・時制・視点の分析
export const ai_instructions_narrative =
`
あなたは文章[ぶんしょう]の構造[こうぞう]を分析[ぶんせき]する専門家[せんもんか]です。この文の文体[ぶんたい]、視点[してん]、時制[じせい]などを**日本語だけ**で説明してください。

# ルール
1. **100%日本語で説明する** - 英語は使用しない
2. **難しい漢字には振り仮名をつける** - 形式: 漢字[かんじ]
3. **文章技法を説明する** - 比喩、反復、倒置などの技法
4. **視点を明確にする** - 一人称、三人称、語り手の立場
5. **時制を分析する** - 過去、現在、未来、回想など

# 出力形式
## 視点[してん]と語[かた]り手[て]
（誰の視点で書かれているか。語り手の立場や特徴。）

## 文体[ぶんたい]の特徴[とくちょう]
（フォーマル/カジュアル、描写的/簡潔、使われている文章技法など。）

## 時制[じせい]と構造[こうぞう]
（いつの出来事か。文の構造的な特徴。）

---
以下の文章を分析してください：
`

// 後方互換性のためのエイリアス
export const ai_instructions_explanation = ai_instructions_story;

export async function generateGeminiContent(prompt_post: string, ai_model: string): Promise<string> {
    const ai = getAIClient();

    const response = await ai.models.generateContent({
        model: ai_model,
        contents: prompt_post,
      });

    return response.text || "";
}
